# Use the official Debian image
FROM debian:12.9

# Set environment variables for Git over HTTP
ENV GIT_PROJECT_ROOT=/srv/git
ENV GIT_HTTP_EXPORT_ALL=1
ENV REMOTE_USER=git
ENV GIT_ALLOW_PUSH=1

# Install Apache, Git, and utilities
RUN apt-get update && \
    apt-get install -y apache2 git && \
    apt-get clean

# Fix Apache environment file (use Bash syntax)
RUN echo 'export APACHE_PID_FILE=/var/run/apache2/apache2.pid' >> /etc/apache2/envvars && \
    echo 'export GIT_PROJECT_ROOT=/srv/git' >> /etc/apache2/envvars && \
    echo 'export GIT_HTTP_EXPORT_ALL=1' >> /etc/apache2/envvars && \
    echo 'export REMOTE_USER=git' >> /etc/apache2/envvars && \
    echo 'export GIT_ALLOW_PUSH=1' >> /etc/apache2/envvars

# Copy Apache configuration
COPY git.conf /etc/apache2/sites-available/000-default.conf

# Enable necessary Apache modules
RUN a2enmod cgi alias env

# Set permissions for repositories
RUN mkdir -p /srv/git/test-project.git && \
    cd /srv/git/test-project.git && \
    git init --bare && \
    chown -R www-data:www-data /srv/git && \
    chmod -R 775 /srv/git && \
    find /srv/git/test-project.git -type d -exec chmod 775 {} \; && \
    find /srv/git/test-project.git -type f -exec chmod 664 {} \;

# Add logging for Apache
RUN mkdir -p /var/log/apache2 && \
    touch /var/log/apache2/access.log && \
    touch /var/log/apache2/error.log && \
    chown -R www-data:www-data /var/log/apache2

# Expose Apache port
EXPOSE 80

# Start Apache using "service" command
CMD ["sh", "-c", "service apache2 start && tail -F /var/log/apache2/access.log /var/log/apache2/error.log"]

# Use the specified Nginx base image
FROM nginx:1.27.4-bookworm

# Install required packages
RUN apt-get update && apt-get install -y \
    git \
    fcgiwrap \
    spawn-fcgi \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Create necessary directories
RUN mkdir -p /var/www/git \
    && mkdir -p /var/run/fcgiwrap \
    && chown -R www-data:www-data /var/www/git \
    && chown -R www-data:www-data /var/run/fcgiwrap

# Create a directory for our scripts
RUN mkdir -p /usr/local/bin

# Create verification script
RUN echo '#!/bin/bash\n\
echo "=== Checking Supervisor Status ==="\n\
supervisorctl status\n\
\n\
echo -e "\n=== Checking Nginx Status ==="\n\
nginx -t\n\
\n\
echo -e "\n=== Checking Socket Status ==="\n\
if [ -S "/var/run/fcgiwrap/fcgiwrap.socket" ]; then\n\
    echo "Socket exists. Checking permissions:"\n\
    ls -la /var/run/fcgiwrap/fcgiwrap.socket\n\
    echo -e "\nChecking processes listening on socket:"\n\
    ss -x | grep fcgiwrap\n\
else\n\
    echo "WARNING: Socket file does not exist!"\n\
fi\n\
\n\
echo -e "\n=== Checking Directory Permissions ==="\n\
ls -la /var/www/git\n\
ls -la /var/run/fcgiwrap\n\
' > /usr/local/bin/verify-services.sh

# Make the verification script executable
RUN chmod +x /usr/local/bin/verify-services.sh

# Copy your Nginx configuration
COPY git.conf /etc/nginx/conf.d/default.conf

# Create supervisor configuration
RUN echo "[supervisord]" > /etc/supervisor/conf.d/supervisord.conf \
    && echo "nodaemon=true" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "[program:fcgiwrap]" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "command=spawn-fcgi -s /var/run/fcgiwrap/fcgiwrap.socket -u www-data -g www-data -- /usr/sbin/fcgiwrap" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "stdout_logfile=/dev/stdout" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "stdout_logfile_maxbytes=0" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "autorestart=true" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "[program:nginx]" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "command=nginx -g 'daemon off;'" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "stdout_logfile=/dev/stdout" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "stdout_logfile_maxbytes=0" >> /etc/supervisor/conf.d/supervisord.conf \
    && echo "autorestart=true" >> /etc/supervisor/conf.d/supervisord.conf

# Create a startup script that runs verification and starts supervisor
RUN echo '#!/bin/bash\n\
echo "=== Initial Service Verification ==="\n\
sleep 2  # Give services time to start\n\
/usr/local/bin/verify-services.sh\n\
\n\
echo -e "\n=== Starting Supervisor ==="\n\
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf\n\
' > /usr/local/bin/start-services.sh

# Make the startup script executable
RUN chmod +x /usr/local/bin/start-services.sh

# Set the CMD to use our new startup script
CMD ["/usr/local/bin/start-services.sh"]